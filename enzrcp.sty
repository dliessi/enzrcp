\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{enzrcp}[2013/08/11 v0.4 Typeset recipes for enzyme reactions]

\RequirePackage{float}[2001/11/08]
\RequirePackage{booktabs}[2005/04/14]
\RequirePackage{siunitx}[2012/12/29]
\RequirePackage{schemata}[2013/03/10]
\RequirePackage{kvoptions}[2011/06/30]
\RequirePackage{ifthen}[2001/05/26]

\SetupKeyvalOptions{
 family=enzrcp,
 prefix=enzrcp@
}
\DeclareStringOption[0.9\textwidth]{recipewidth}
\DeclareStringOption[0.45\textwidth]{ingredwidth}
\DeclareStringOption[0.5\textwidth]{ingrednamewidth}
\DeclareStringOption[0.5em]{ingredspacewidth}
\DeclareStringOption[0.5\textwidth]{instrwidth}
\ProcessKeyvalOptions*

\newlength{\enzrcp@privaterecipewidth}
\newlength{\enzrcp@privateingredwidth}
\newlength{\enzrcp@privateingrednamewidth}
\newlength{\enzrcp@privateingredspacewidth}
\newlength{\enzrcp@privateinstrwidth}

\newcommand{\enzrcpspacing}[2]{%
 \ifthenelse{\equal{recipewidth}{#1}}{%
  \ifthenelse{\equal{initial}{#2}}{%
   \setlength{\enzrcp@privaterecipewidth}{\enzrcp@recipewidth}%
  }{%
   \setlength{\enzrcp@privaterecipewidth}{#2}%
  }%
 }{%
  \ifthenelse{\equal{ingredwidth}{#1}}{%
   \ifthenelse{\equal{initial}{#2}}{%
    \setlength{\enzrcp@privateingredwidth}{\enzrcp@ingredwidth}%
   }{%
    \setlength{\enzrcp@privateingredwidth}{#2}%
   }%
  }{%
   \ifthenelse{\equal{ingrednamewidth}{#1}}{%
    \ifthenelse{\equal{initial}{#2}}{%
     \setlength{\enzrcp@privateingrednamewidth}{\enzrcp@ingrednamewidth}%
    }{%
     \setlength{\enzrcp@privateingrednamewidth}{#2}%
    }%
   }{%
    \ifthenelse{\equal{ingredspacewidth}{#1}}{%
     \ifthenelse{\equal{initial}{#2}}{%
      \setlength{\enzrcp@privateingredspacewidth}{\enzrcp@ingredspacewidth}%
     }{%
      \setlength{\enzrcp@privateingredspacewidth}{#2}%
     }%
    }{%
     \ifthenelse{\equal{instrwidth}{#1}}{%
      \ifthenelse{\equal{initial}{#2}}{%
       \setlength{\enzrcp@privateinstrwidth}{\enzrcp@instrwidth}%
      }{%
       \setlength{\enzrcp@privateinstrwidth}{#2}%
      }%
     }{%
      \ifthenelse{\equal{all}{#1}}{%
       \ifthenelse{\equal{initial}{#2}}{%
        \setlength{\enzrcp@privaterecipewidth}{\enzrcp@recipewidth}%
        \setlength{\enzrcp@privateingredwidth}{\enzrcp@ingredwidth}%
        \setlength{\enzrcp@privateingrednamewidth}{\enzrcp@ingrednamewidth}%
        \setlength{\enzrcp@privateingredspacewidth}{\enzrcp@ingredspacewidth}
        \setlength{\enzrcp@privateinstrwidth}{\enzrcp@instrwidth}%
       }{%
        \PackageError{enzrcp}%
{Invalid arguments to \string\enzrcpspacing}%
{The second argument should be 'initial' if the first is 'all'.}%
       }%
      }{%
       \PackageError{enzrcp}%
{Invalid arguments to \string\enzrcpspacing}%
{The first argument must be one of the following:\MessageBreak
recipewidth, ingredwidth, ingrednamewidth, ingredspacewidth,\MessageBreak
instrwidth, all.}%
      }%
     }%
    }%
   }%
  }%
 }%
}

\enzrcpspacing{all}{initial}

\newcommand\fs@plaintopbf{\fs@plaintop
\def\@fs@cfont{\sffamily\bfseries}}
\let\floatc@plaintop=\floatc@plain
\let\float@captionold\caption
\renewcommand{\caption}[1]{\float@captionold{\textsf{#1}}}

\floatstyle{plaintopbf}
\newfloat{Recipe}{tbp}{rcp}


\sisetup{detect-family}


\newcommand{\NB}{\textbf{N.B.} }


\newcommand{\ingred}[3]{#1&#2&\si{#3}\\}


\newcommand{\recipe}[5][]{%
\begin{Recipe}[H]
\caption{#3}
\label{rcp:#2}
\medskip
\centering
\begin{minipage}[t]{\enzrcp@recipewidth}
\sffamily
\begin{minipage}[c]{\enzrcp@ingredwidth}
\begin{tabular}{p{\enzrcp@ingrednamewidth}@{\hspace{\enzrcp@ingredspacewidth}}S@{}s}
\toprule
#4
\bottomrule
\end{tabular}
\end{minipage}
\hfill
\begin{minipage}[c]{\enzrcp@instrwidth}
#5
\end{minipage}
\smallskip
\if\relax\detokenize{#1}\relax\else\par\smallskip\NB#1\fi
\end{minipage}
\end{Recipe}}


\newcommand{\enzrcp}[6][]{%
\recipe[#1]{#2}{#3}{#4}{%
\if\relax\detokenize{#5}\relax\else\textbf{Incubation:} #5\fi

\smallskip
\if\relax\detokenize{#6}\relax\else\textbf{Inactivation:} #6\fi}}


\newcommand{\enzrcpTemp}[1]{\SI{#1}{\degreeCelsius}}
\newcommand{\enzrcpTime}[2]{\if\relax\detokenize{#1}\relax\else\SI{#1}{\arcminute}\fi%
\if\relax\detokenize{#2}\relax\else\SI{#2}{\arcsecond}\fi}
\newcommand{\enzrcpTimeTemp}[3]{\enzrcpTime{#1}{#2}~@~\enzrcpTemp{#3}}


\newcommand{\PCR}[9][]{%
\def\enzrcpNB{#1}%\if\relax\detokenize{#1}\relax\else\par\smallskip\NB#1\fi}%
\def\enzrcpID{#2}%
\def\enzrcpCaption{#3}%
\def\enzrcpIngred{#4}%
\def\enzrcpMeltingInitial{#5}%
\def\enzrcpCycle{#6 $\times$}
\def\enzrcpMeltingCycle{#7}%
\def\enzrcpAnnealing{#8}%
\def\enzrcpElongationCycle{#9}%
\PCRcontinuedA%
}

\newcommand{\PCRcontinuedA}[2]{%
\def\enzrcpElongationFinal{#1}%
\def\enzrcpStorage{\enzrcpTemp{#2}~$\infty$}%
\recipe[\enzrcpNB]{\enzrcpID}{\enzrcpCaption}{\enzrcpIngred}{%
\textbf{Melting:} \enzrcpMeltingInitial

\schema{\schemabox{\enzrcpCycle}}{\schemabox{%
\textbf{Melting:} \enzrcpMeltingCycle\\
\textbf{Annealing:} \enzrcpAnnealing\\
\textbf{Elongation:} \enzrcpElongationCycle}}

\textbf{Elongation:} \enzrcpElongationFinal

\textbf{Storage:} \enzrcpStorage}}
